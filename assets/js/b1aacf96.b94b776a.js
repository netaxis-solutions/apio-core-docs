"use strict";(self.webpackChunkapio_core=self.webpackChunkapio_core||[]).push([[6342],{63039:(e,t,s)=>{s.r(t),s.d(t,{assets:()=>h,contentTitle:()=>i,default:()=>a,frontMatter:()=>o,metadata:()=>d,toc:()=>c});var n=s(85893),r=s(11151);const o={sidebar_position:1},i="Custom routes",d={id:"triggers/custom_routes",title:"Custom routes",description:"APIO core supports custom HTTP routes. You can use them to expose your workflows to create your own API calls.",source:"@site/docs/triggers/custom_routes.md",sourceDirName:"triggers",slug:"/triggers/custom_routes",permalink:"/apio-core-docs/docs/triggers/custom_routes",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1},sidebar:"tutorialSidebar",previous:{title:"Triggers",permalink:"/apio-core-docs/docs/category/triggers"},next:{title:"Scheduled jobs",permalink:"/apio-core-docs/docs/triggers/scheduled_jobs"}},h={},c=[{value:"Definition",id:"definition",level:3},{value:"Synchronous vs Asynchronous routes",id:"synchronous-vs-asynchronous-routes",level:2},{value:"Error handler",id:"error-handler",level:2},{value:"Asynchronous response sample",id:"asynchronous-response-sample",level:3},{value:"Synchronous response",id:"synchronous-response",level:3},{value:"Samples Response",id:"samples-response",level:4},{value:"Downloadable file",id:"downloadable-file",level:4},{value:"Authenticated routes",id:"authenticated-routes",level:2},{value:"Public routes",id:"public-routes",level:2},{value:"Proxied routes",id:"proxied-routes",level:2},{value:"API documentation",id:"api-documentation",level:3},{value:"Documentation",id:"documentation",level:2}];function l(e){const t={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",h4:"h4",img:"img",li:"li",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.a)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(t.h1,{id:"custom-routes",children:"Custom routes"}),"\n",(0,n.jsx)(t.p,{children:"APIO core supports custom HTTP routes. You can use them to expose your workflows to create your own API calls."}),"\n",(0,n.jsxs)(t.p,{children:["Page: ",(0,n.jsx)(t.code,{children:"/transactions/config/startup_events"})]}),"\n",(0,n.jsx)(t.h3,{id:"definition",children:"Definition"}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.img,{alt:"Custom route definition",src:s(89052).Z+"",width:"603",height:"1360"})}),"\n",(0,n.jsxs)(t.table,{children:[(0,n.jsx)(t.thead,{children:(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.th,{children:"Attribute"}),(0,n.jsx)(t.th,{children:"Description"})]})}),(0,n.jsxs)(t.tbody,{children:[(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:"Route"}),(0,n.jsx)(t.td,{children:"The path of the route."})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:"Method"}),(0,n.jsx)(t.td,{children:"The HTTP method of the route."})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:"Group"}),(0,n.jsx)(t.td,{children:"The group of the route."})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:"JSON Schema"}),(0,n.jsx)(t.td,{children:"The request body can be validated with a JSON schema before launching the workflow."})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:"Output JSON Schema"}),(0,n.jsx)(t.td,{children:"The response body can be described for the OpenAPI generator."})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:"Error handler"}),(0,n.jsxs)(t.td,{children:["The workflow to launch when a blocking error occurs (see ",(0,n.jsx)(t.a,{href:"#error-handler",children:"here"}),")."]})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:"Enabled"}),(0,n.jsx)(t.td,{children:"The route is enabled."})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:"Sync"}),(0,n.jsxs)(t.td,{children:["The route is synchronous (see ",(0,n.jsx)(t.a,{href:"#synchronous-vs-asynchronous-routes",children:"here"}),")."]})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:"Public"}),(0,n.jsx)(t.td,{children:"The route does not require authentication."})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:"Support bulk"}),(0,n.jsx)(t.td,{children:"The route supports bulk requests."})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:"Bulk options"}),(0,n.jsx)(t.td,{children:"The options of the bulk requests."})]})]})]}),"\n",(0,n.jsx)(t.h2,{id:"synchronous-vs-asynchronous-routes",children:"Synchronous vs Asynchronous routes"}),"\n",(0,n.jsx)(t.p,{children:"The custom routes can be synchronous or asynchronous. The synchronous routes are executed in the same thread as the HTTP request. The asynchronous routes are executed in a separate thread."}),"\n",(0,n.jsx)(t.p,{children:"The synchronous routes are useful when the workflow is fast. The asynchronous routes are useful when the workflow is slow or long-running. In this case, the workflow can be launched in a separate thread and the HTTP request can be closed. The workflow can continue to run in the background."}),"\n",(0,n.jsxs)(t.p,{children:["When the route is asynchronous, the response is sent immediately. The response contains the ID and the GUID of the transaction. The transaction can be used to track the status of the workflow. (via the API ",(0,n.jsx)(t.code,{children:"GET /api/v01/transactions/{id}"})," or via the UI ",(0,n.jsx)(t.code,{children:"/transactions/{id}"}),")"]}),"\n",(0,n.jsx)(t.h2,{id:"error-handler",children:"Error handler"}),"\n",(0,n.jsx)(t.p,{children:"The error handler is a workflow that is executed when a blocking error occurs. You can see that as a try/catch mechanism."}),"\n",(0,n.jsxs)(t.p,{children:["It receives a ",(0,n.jsx)(t.code,{children:"{request}"})," containing the following attributes:"]}),"\n",(0,n.jsxs)(t.table,{children:[(0,n.jsx)(t.thead,{children:(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.th,{children:"Attribute"}),(0,n.jsx)(t.th,{children:"Description"})]})}),(0,n.jsxs)(t.tbody,{children:[(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:"instance"}),(0,n.jsx)(t.td,{children:"the top parent instance"})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:"context"}),(0,n.jsx)(t.td,{children:"the top parent context"})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:"request"}),(0,n.jsx)(t.td,{children:"the initial request received by the custom route"})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:"errors"}),(0,n.jsx)(t.td,{children:"the list of errors attached to the top parent instance"})]})]})]}),"\n",(0,n.jsxs)(t.p,{children:["In case of a synchronous route, the error handler is executed before sending the response. So the response can be customized based on the error. When the error workflow completes succesfully, the context keys ",(0,n.jsx)(t.code,{children:"*response*"})," and ",(0,n.jsx)(t.code,{children:"*cb_response*"})," are moved from the error handler instance to the top parent instance, and then used to build the response."]}),"\n",(0,n.jsx)(t.p,{children:"In case of an asynchronous route, the error handler can be used to send a notification or a callback to the user or to the administrator."}),"\n",(0,n.jsx)(t.h3,{id:"asynchronous-response-sample",children:"Asynchronous response sample"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-json",children:'{\n    "id": 1,\n    "guid": "70195486-8934-4a31-a504-a97a72c7f322"\n}\n'})}),"\n",(0,n.jsx)(t.h3,{id:"synchronous-response",children:"Synchronous response"}),"\n",(0,n.jsxs)(t.p,{children:["When the route is synchronous, the response is sent when the workflow reach an ",(0,n.jsx)(t.a,{href:"../workflows/nodes#end",children:"end"})," node. The response is evaluated based on the context key ",(0,n.jsx)(t.code,{children:"*response*"})," (set with a ",(0,n.jsx)(t.a,{href:"../workflows/nodes#context-setter",children:"context setter"})," node for instance)."]}),"\n",(0,n.jsx)(t.p,{children:"The value has to be a JSON object with the following attributes:"}),"\n",(0,n.jsxs)(t.table,{children:[(0,n.jsx)(t.thead,{children:(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.th,{children:"Attribute"}),(0,n.jsx)(t.th,{children:"Description"})]})}),(0,n.jsxs)(t.tbody,{children:[(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:"status"}),(0,n.jsx)(t.td,{children:"The HTTP status code of the response."})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:"body"}),(0,n.jsx)(t.td,{children:"The body of the response. It can be a string or a JSON object."})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:"headers"}),(0,n.jsx)(t.td,{children:"A JSON object with the headers to be added in the response."})]})]})]}),"\n",(0,n.jsx)(t.admonition,{type:"tip",children:(0,n.jsxs)(t.p,{children:["Because there is a match in the structure of the output of ",(0,n.jsx)(t.a,{href:"../workflows/nodes#http-call",children:"http call nodes"})," and the structure of the response of the custom routes, the http call nodes can output directly in the ",(0,n.jsx)(t.code,{children:"*response*"})," context key without further processing."]})}),"\n",(0,n.jsx)(t.admonition,{type:"tip",children:(0,n.jsxs)(t.p,{children:["If the ",(0,n.jsx)(t.code,{children:"*response*"})," value is not a valid JSON object, the workflow can be closed succesfully but the response will have a status 500 (Internal Server Error)."]})}),"\n",(0,n.jsx)(t.h4,{id:"samples-response",children:"Samples Response"}),"\n",(0,n.jsxs)("table",{children:[(0,n.jsx)("thead",{children:(0,n.jsxs)("tr",{children:[(0,n.jsx)("th",{children:" Description "}),(0,n.jsxs)("th",{children:[" Value of ",(0,n.jsx)(t.em,{children:"response"})," key "]}),(0,n.jsx)("th",{children:" Response "})]})}),(0,n.jsxs)("tbody",{children:[(0,n.jsxs)("tr",{children:[(0,n.jsx)("td",{children:"JSON response"}),(0,n.jsx)("td",{children:(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-json",children:'{\n  "status": 200,\n  "body": {\n    "message": "hello, world"\n  }\n}\n'})})}),(0,n.jsx)("td",{children:(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-http",children:'HTTP/1.1 200 OK\nContent-Type: application/json\n\n{\n  "message": "hello, world"\n}\n'})})})]}),(0,n.jsxs)("tr",{children:[(0,n.jsx)("td",{children:"Plain response"}),(0,n.jsx)("td",{children:(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-json",children:'{\n  "status": 200,\n  "body": "hello, world"\n}\n'})})}),(0,n.jsx)("td",{children:(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-http",children:"HTTP/1.1 200 OK\nContent-Type: text/plain\n\nhello, world\n"})})})]}),(0,n.jsxs)("tr",{children:[(0,n.jsx)("td",{children:"File attachment response"}),(0,n.jsx)("td",{children:(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-json",children:'{\n  "status": 200,\n  "body": "hello, world",\n  "headers": {\n      "content-disposition": "attachment; filename=\\"hello.txt\\"",\n      "content-type": "text/plain"\n  }\n}\n'})})}),(0,n.jsx)("td",{children:(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-http",children:'HTTP/1.1 200 OK\nContent-Type: text/plain\nContent-Disposition: attachment; filename="hello.txt"\n\nhello, world\n'})})})]})]})]}),"\n",(0,n.jsx)(t.h4,{id:"downloadable-file",children:"Downloadable file"}),"\n",(0,n.jsxs)(t.p,{children:["If the workflow build up a file (e.g ",(0,n.jsx)(t.a,{href:"../workflows/nodes#csv-file",children:"csv"}),", ",(0,n.jsx)(t.a,{href:"../workflows/nodes#excel-file",children:"Excel"})," etc...) and the response has to be a downloadable file, the context key ",(0,n.jsx)(t.code,{children:"*doc_response*"})," has to be set with the filename of the file built by the workflow."]}),"\n",(0,n.jsx)(t.p,{children:"The status code of the response is set to 200 (OK) and the content type is set to the MIME type of the file."}),"\n",(0,n.jsx)(t.p,{children:"For the interest of the reader, here a basic workflow definition that builds a CSV file and returns it as a downloadable file."}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-json",children:'{\n\t"cells": {\n\t\t"start": {\n\t\t\t"original_name": "start",\n\t\t\t"outputs":       ["ok"]\n\t\t},\n\t\t"a": {\n\t\t\t"original_name": "create_csv",\n\t\t\t"params": {\n\t\t\t\t"filename":   "doc1.csv",\n\t\t\t\t"inputs": "[[\\"hello\\", \\"world\\"], [\\"foo\\", \\"bar\\"]]"\n\t\t\t},\n\t\t\t"outputs": ["ok"]\n\t\t},\n\t\t"b": {\n\t\t\t"original_name": "context_setter",\n\t\t\t"params": {\n\t\t\t\t"key":   "*doc_response*",\n\t\t\t\t"value": "doc1.csv"\n\t\t\t},\n\t\t\t"outputs": ["ok"]\n\t\t},\n\t\t"end": {\n\t\t\t"original_name": "end"\n\t\t}\n\t},\n\t"transitions": [\n\t\t["start.ok", "a"],\n\t\t["a.ok", "b"],\n\t\t["b.ok", "end"]\n\t]\n}\n'})}),"\n",(0,n.jsx)(t.h2,{id:"authenticated-routes",children:"Authenticated routes"}),"\n",(0,n.jsxs)(t.p,{children:["By default, all custom routes are authenticated. The authentication is done using the JWT token. The JWT token is added to the ",(0,n.jsx)(t.code,{children:"Authorization"})," header (Bearer ",(0,n.jsx)(t.a,{href:"https://developer.mozilla.org/en-US/docs/Web/HTTP/Authentication",children:"authentication scheme"}),") of the HTTP requests."]}),"\n",(0,n.jsxs)(t.p,{children:["Such routes are exposed under the ",(0,n.jsx)(t.code,{children:"/api/v01/custom"})," path. For example, the route ",(0,n.jsx)(t.code,{children:"/my-route"})," is exposed as ",(0,n.jsx)(t.code,{children:"https://api.example.com/api/v01/custom/my-route"}),"."]}),"\n",(0,n.jsx)(t.h2,{id:"public-routes",children:"Public routes"}),"\n",(0,n.jsxs)(t.p,{children:["The custom routes can be public. In this case, they do not require authentication. Such routes are exposed under the ",(0,n.jsx)(t.code,{children:"/api/v01/public"})," path. For example, the route ",(0,n.jsx)(t.code,{children:"/my-route"})," is exposed as ",(0,n.jsx)(t.code,{children:"https://api.example.com/public/my-route"}),"."]}),"\n",(0,n.jsx)(t.p,{children:"Public routes are useful when you want to expose your workflows to external systems in a secure environment. (e.g. a private network or health check)"}),"\n",(0,n.jsx)(t.h2,{id:"proxied-routes",children:"Proxied routes"}),"\n",(0,n.jsxs)(t.p,{children:["APIO core can be deployed with one or several proxies to intercept and/or forward some traffic to a Broadsoft gateway (Netaxis product). In this case, the proxy process will use the custom routes to ",(0,n.jsx)(t.em,{children:"overload"})," or ",(0,n.jsx)(t.em,{children:"extend"})," the Broadsoft gateway API calls."]}),"\n",(0,n.jsxs)(t.p,{children:["Proxied routes are usually exposed under the ",(0,n.jsx)(t.code,{children:"/api/v01/p{id}"})," path. For example, the route ",(0,n.jsx)(t.code,{children:"/my-route"})," is exposed as ",(0,n.jsx)(t.code,{children:"https://api.example.com/api/v01/p1/my-route"}),"."]}),"\n",(0,n.jsx)(t.p,{children:"All proxied routes require the user to be authenticated."}),"\n",(0,n.jsxs)(t.admonition,{type:"caution",children:[(0,n.jsx)(t.p,{children:"Proxied routes (not overloaded by custom routes) are executed with different user sessions depending of the originating user:"}),(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsx)(t.li,{children:"The user is a Broadsoft user, the route is executed with the user session."}),"\n",(0,n.jsx)(t.li,{children:"The user is an APIO user, the user profile is used to allow or deny the execution of the route. If the user profile is allowed to execute the route, the route is executed with the system level session."}),"\n"]}),(0,n.jsx)(t.p,{children:"There is no risk of impersonation because the user session is always used for Broadsoft users."})]}),"\n",(0,n.jsxs)(t.p,{children:["Some nodes are especially usefull in the context of the proxied routes, e.g. ",(0,n.jsx)(t.a,{href:"../workflows/nodes/#broadsoft-proxy-session-call",children:"Proxy user session"})," node, to use the user session to make calls to the Broadsoft gateway."]}),"\n",(0,n.jsx)(t.h3,{id:"api-documentation",children:"API documentation"}),"\n",(0,n.jsxs)(t.p,{children:["The Broadsoft gateway API is described ",(0,n.jsx)(t.a,{href:"https://apio-docs.bxl.netaxis.be/",children:"here"}),"."]}),"\n",(0,n.jsxs)(t.admonition,{type:"caution",children:[(0,n.jsxs)(t.p,{children:["The documentation mention paths with a prefix ",(0,n.jsx)(t.code,{children:"/api/v1"})," but ther are exposed under the ",(0,n.jsx)(t.code,{children:"/api/v01/p{id}"})," path on the proxy."]}),(0,n.jsxs)(t.p,{children:["e.g ",(0,n.jsx)(t.code,{children:"/api/v1/tenants/"})," is exposed at ",(0,n.jsx)(t.code,{children:"/api/v01/p{id}/tenants/"}),"."]})]}),"\n",(0,n.jsx)(t.h2,{id:"documentation",children:"Documentation"}),"\n",(0,n.jsxs)(t.p,{children:["The custom routes are documented in the OpenAPI generated specification. The specification is available at the ",(0,n.jsx)(t.code,{children:"/api/v01/custom_routes.swagger.yml"})," path. For example, ",(0,n.jsx)(t.code,{children:"https://api.example.com/api/v01/custom_routes.swagger.yml"}),"."]})]})}function a(e={}){const{wrapper:t}={...(0,r.a)(),...e.components};return t?(0,n.jsx)(t,{...e,children:(0,n.jsx)(l,{...e})}):l(e)}},89052:(e,t,s)=>{s.d(t,{Z:()=>n});const n=s.p+"assets/images/new-custom-route-69aa8eb156cf13cbe4585886b1c0b0eb.png"},11151:(e,t,s)=>{s.d(t,{Z:()=>d,a:()=>i});var n=s(67294);const r={},o=n.createContext(r);function i(e){const t=n.useContext(o);return n.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function d(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),n.createElement(o.Provider,{value:t},e.children)}}}]);